<html>
    <head>
        <meta charset=utf-8 />
        <title>Geotrio 2.0</title>
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
        <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.js'></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.css' rel='stylesheet' />
        <style>
            body { margin:0; padding:0; }
            #map { position:absolute; top:0; bottom:0; width:100%; }
        </style>
    </head>
    <body>
        <div id='map'></div>
        <script>
            L.mapbox.accessToken = 'pk.eyJ1IjoiYW5uYWNoaW5uIiwiYSI6Il9FWFVaX3MifQ.LWyZpBRxnoARXldAE_ilcQ';
            var map = L.mapbox.map('map', 'examples.map-i86nkdio')
            .setView([45.5217, -73.6673], 11);
            var featureLayer = $.getJSON("https://spreadsheets.google.com/feeds/list/1QaPb_Hnnq3WozVeMHaq0t1k0_nIr3XuFyEf4Pyrza4U/ov3895y/public/values?alt=json", function(data){  
                $.each(data.feed.entry, function(index, value) {
                    if (value.gsx$latitude.$t === ""){
                        return true;
                    } else if (value.gsx$longitude.$t === ""){
                        return true;
                    } else {
                        var lat = Number(value.gsx$latitude.$t);
                        var lng = Number(value.gsx$longitude.$t);
                        var time = value.gsx$timestamp.$t;
                        var location = value.gsx$streetintersectionorapproximatestreetaddressoftheaccident.$t;
                        var city =  value.gsx$cityofbikeaccident.$t;
						
                        var colour = function() {
                            var cause = value.gsx$causeofthebikingaccident.$t;
                                switch (cause) {
                                    case 'Obstruction in bike path':
                                        return '#FFCCFF'
                                        break;
                                    case 'Traffic altercation':
                                        return '#FFCC66'
                                        break;
                                    case 'Missing traffic sign or signal':
                                        return '#FF66CC'
                                        break;
                                    case 'Poor weather conditions':
                                        return '#CC66FF'
                                        break;
                                    case 'No bike path':
                                        return '#FFFF66'
                                        break;
                                    default:
                                        return '#FF3333'
                                };
                            };
                        
                        L.mapbox.featureLayer({
                            type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: [lng,lat]
                            },
                            properties: {
                                title: location,
                                description: time,
                                'marker-size': 'medium',
                                'marker-color': colour(),
                                'marker-symbol': 'bicycle'
                            }
                        }).addTo(map);
                    };
                });
            });

//setTimeout(function(){
//   window.location.reload(1);
//}, 5000);
        </script>
    </body>
</html>

